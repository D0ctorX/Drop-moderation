<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drop | Modération & Marketing</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        :root {
            --primary-bg: #FAFAFA;
            --secondary-bg: #FFFFFF;
            --sidebar-bg: #FFFFFF;
            --border-color: #DBDBDB;
            --text-color: #262626;
            --highlight-color: #3897f0;
            --danger-color: #E74C3C;
            --success-color: #2ECC71;
            --warning-color: #F1C40F;
            --gray-text: #8E8E8E;
            --patron-color: #8e44ad;
            --google-btn: #4285F4;
        }

        body {
            margin: 0; padding: 0; font-family: 'Inter', sans-serif;
            background-color: var(--primary-bg); color: var(--text-color);
            height: 100vh; display: flex; overflow: hidden;
        }

        /* --- LOGIN VIEW --- */
        #auth-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--primary-bg); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
        }
        .auth-card {
            background: var(--secondary-bg); padding: 40px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 350px; text-align: center;
            border: 1px solid var(--border-color);
        }
        .logo { font-family: 'Inter', sans-serif; font-weight: 800; font-size: 28px; margin-bottom: 20px; display:block;}
        .logo span { color: var(--highlight-color); }
        .auth-input {
            width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border-color);
            border-radius: 6px; background: #fafafa;
        }
        .btn {
            width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: 600;
            cursor: pointer; transition: opacity 0.2s; color: white; background-color: var(--highlight-color);
            margin-bottom: 10px;
        }
        .btn:hover { opacity: 0.9; }
        .btn-google { background-color: var(--google-btn); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-success { background-color: var(--success-color); }
        
        .divider { display: flex; align-items: center; margin: 15px 0; color: #888; font-size: 12px; }
        .divider::before, .divider::after { content: ""; flex: 1; border-bottom: 1px solid #ddd; }
        .divider::before { margin-right: 10px; }
        .divider::after { margin-left: 10px; }

        /* --- MAIN LAYOUT --- */
        #app-container { display: none; width: 100%; height: 100%; }

        /* SIDEBAR */
        .sidebar {
            width: 250px; background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; padding: 20px 0; flex-shrink: 0;
        }
        .sidebar-header { padding: 0 20px 30px; }
        .nav-item {
            padding: 15px 20px; cursor: pointer; color: var(--text-color); font-weight: 500;
            display: flex; align-items: center; gap: 10px; transition: background 0.2s;
        }
        .nav-item:hover { background-color: #f0f0f0; }
        .nav-item.active { border-left: 4px solid var(--highlight-color); background-color: #f8fbff; color: var(--highlight-color); }
        .nav-item.disabled { opacity: 0.4; pointer-events: none; cursor: not-allowed; background: #f9f9f9; color: #ccc; }
        .nav-item i { width: 20px; text-align: center; }

        /* CONTENT */
        .main-content { flex-grow: 1; overflow-y: auto; padding: 30px; position: relative; }
        .section-view { display: none; animation: fadeIn 0.3s; }
        .section-view.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }

        /* DASHBOARD CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--highlight-color); margin: 10px 0; }
        .stat-label { font-size: 14px; color: var(--gray-text); }

        /* CMS EDITING */
        .cms-item { background: #fff; border: 1px solid #eee; padding: 15px; margin-bottom: 10px; border-radius: 6px; display: flex; gap: 10px; align-items: flex-start; }
        .cms-content { flex-grow: 1; display: flex; flex-direction: column; gap: 5px; }
        .cms-actions { display: flex; flex-direction: column; gap: 5px; }
        .cms-input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .action-icon-btn { background: none; border: none; cursor: pointer; color: var(--gray-text); transition: color 0.2s; }
        .action-icon-btn:hover { color: var(--danger-color); }

        /* USERS TABLE */
        .search-bar { width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 6px; }
        .data-table { width: 100%; border-collapse: collapse; background: white; font-size: 14px; }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .data-table th { background-color: #f9f9f9; font-weight: 600; color: var(--gray-text); }
        .user-row:hover { background-color: #f0f0f0; cursor: pointer; }
        .badge-tag { padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; margin-right: 5px; color: white; display: inline-block; }
        .badge-vip { background-color: var(--warning-color); }
        .badge-staff { background-color: var(--highlight-color); }
        .badge-certif { background-color: var(--success-color); }
        
        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5);
            display: none; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal { background: white; padding: 30px; border-radius: 12px; width: 400px; max-width: 90%; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .checkbox-group { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .checkbox-item { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        
        /* FEEDBACKS */
        .feedback-item { background: white; border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .feedback-meta { font-size: 12px; color: var(--gray-text); margin-bottom: 5px; display: flex; justify-content: space-between; }
        
        /* TOAST */
        #toast { position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; background: #333; color: white; border-radius: 4px; display: none; z-index: 3000; }

    </style>
</head>
<body>

    <!-- AUTH SCREEN -->
    <div id="auth-view">
        <div class="auth-card">
            <div class="logo">Drop <span>Modération</span></div>
            <p style="color:#666; font-size:14px; margin-bottom:20px;">Accès restreint (Staff & Patrons)</p>
            
            <input type="email" id="admin-email" class="auth-input" placeholder="Email">
            <input type="password" id="admin-password" class="auth-input" placeholder="Mot de passe">
            <button id="login-btn" class="btn">Connexion</button>
            
            <div class="divider">OU</div>
            
            <button id="google-login-btn" class="btn btn-google"><i class="fab fa-google"></i> Connexion avec Google</button>
            
            <div id="login-msg" style="margin-top:10px; font-size:12px; color: var(--danger-color); white-space: pre-wrap;"></div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-container">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">Drop <span>Admin</span></div>
                <div style="font-size:12px; color:#888;">Role: <b id="user-role-display">...</b></div>
            </div>
            <nav>
                <div class="nav-item active" data-target="dashboard" onclick="switchTab('dashboard')"><i class="fas fa-chart-line"></i> Dashboard</div>
                <div class="nav-item" data-target="patrons" onclick="switchTab('patrons')"><i class="fas fa-briefcase"></i> Patrons & Parrainage</div>
                <div class="nav-item" data-target="users" onclick="switchTab('users')"><i class="fas fa-users"></i> Gestion Utilisateurs</div>
                <div class="nav-item" data-target="cms" onclick="switchTab('cms')"><i class="fas fa-edit"></i> Roadmap (CMS)</div>
                <div class="nav-item" data-target="feedbacks" onclick="switchTab('feedbacks')"><i class="fas fa-comment-dots"></i> Feedbacks</div>
            </nav>
            <div style="margin-top: auto; padding: 20px;">
                <button onclick="logout()" style="background:none; border:none; color:var(--danger-color); cursor:pointer; font-weight:600;"><i class="fas fa-sign-out-alt"></i> Déconnexion</button>
            </div>
        </div>

        <!-- CONTENT -->
        <div class="main-content">
            
            <!-- DASHBOARD -->
            <div id="dashboard-view" class="section-view active">
                <h2>Vue d'ensemble</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Utilisateurs Totaux</div>
                        <div class="stat-value" id="stat-total-users">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Posts Totaux</div>
                        <div class="stat-value" id="stat-total-posts">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Groupes Actifs</div>
                        <div class="stat-value" id="stat-total-groups">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Retours (Feedbacks)</div>
                        <div class="stat-value" id="stat-feedbacks-count">-</div>
                    </div>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); height: 300px;">
                    <canvas id="growthChart"></canvas>
                </div>
            </div>

            <!-- USERS MANAGEMENT (Admin Only) -->
            <div id="users-view" class="section-view">
                <h2>Gestion des Utilisateurs</h2>
                <input type="text" id="user-search" class="search-bar" placeholder="Rechercher par pseudo ou ID..." onkeyup="filterUsers()">
                <div style="overflow-x:auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Avatar</th>
                                <th>Pseudo</th>
                                <th>ID</th>
                                <th>Badges</th>
                                <th>Parrainé par</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <!-- JS Generated -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PATRONS -->
            <div id="patrons-view" class="section-view">
                <h2>Espace Patrons & Parrainage</h2>
                <div style="display:flex; gap:20px; align-items:flex-start; flex-wrap: wrap;">
                    <!-- Leaderboard -->
                    <div class="stat-card" style="flex: 2; min-width: 300px; width: 100%;">
                        <h3>Classement des Patrons</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Patron</th>
                                    <th>Parrainés</th>
                                    <th>Lien</th>
                                </tr>
                            </thead>
                            <tbody id="patrons-table-body">
                                <tr><td colspan="3">Chargement...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- CMS (Admin Only) -->
             <div id="cms-view" class="section-view">
                <h2>Édition Roadmap</h2>
                
                <div style="margin-bottom: 40px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h3>Roadmap (Devlog)</h3>
                        <button class="btn btn-success" onclick="addRoadmapItem()" style="width:auto; font-size:12px;"><i class="fas fa-plus"></i> Ajouter</button>
                    </div>
                    <div id="cms-roadmap-container"></div>
                </div>
                
                <div style="position:sticky; bottom:20px; text-align:right; margin-top:20px;">
                     <button class="btn" onclick="saveCMS()" style="width:auto; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">Enregistrer</button>
                </div>
            </div>

            <!-- FEEDBACKS (Admin Only) -->
            <div id="feedbacks-view" class="section-view">
                <h2>Retours Utilisateurs</h2>
                <div id="feedback-list">
                    <!-- JS Generated -->
                </div>
            </div>

        </div>
    </div>

    <!-- USER EDIT MODAL -->
    <div id="user-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 style="margin:0;">Modifier l'utilisateur</h3>
                <i class="fas fa-times" style="cursor:pointer;" onclick="closeModal()"></i>
            </div>
            <div id="modal-user-info" style="margin-bottom:20px; font-size:14px; color:#555;"></div>
            
            <label style="font-weight:bold;">Attribution de Badges</label>
            <div class="checkbox-group">
                <label class="checkbox-item"><input type="checkbox" id="badge-staff"> Staff Drop (Admin)</label>
                <label class="checkbox-item"><input type="checkbox" id="badge-vip"> VIP (Utilisateur Important)</label>
                <label class="checkbox-item"><input type="checkbox" id="badge-certif"> Certifié (Créateur)</label>
                <label class="checkbox-item"><input type="checkbox" id="badge-patron"> Patron (Marketing)</label>
            </div>

            <div class="modal-actions">
                <button class="btn" style="background:#ccc; color:black;" onclick="closeModal()">Annuler</button>
                <button class="btn" onclick="saveUserChanges()">Enregistrer</button>
            </div>
        </div>
    </div>

    <div id="toast"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, getDoc, setDoc, doc, updateDoc, query, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const appId = '1:541715107757:web:0141b71ee3cd1ce5ec5b24';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
             apiKey: "AIzaSyB_z5U4yKJERho93p9696NujcG5R5fvlD8",
             authDomain: "studio-3374032724-f28d6.firebaseapp.com",
             projectId: "studio-3374032724-f28d6",
             appId: appId
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- CONSTANTS ---
        const dbPath = `artifacts/${appId}/public/data`;
        const usersRef = collection(db, dbPath, 'users');
        const postsRef = collection(db, dbPath, 'posts');
        const groupsRef = collection(db, dbPath, 'groups');
        const feedbacksRef = collection(db, dbPath, 'feedbacks');
        const cmsDocRef = doc(db, dbPath, 'cms', 'config');

        // STATE
        let allUsers = [];
        let editingUserId = null;
        let currentUserRole = null; 
        let growthChartInstance = null;

        // --- AUTH LOGIC ---
        const authView = document.getElementById('auth-view');
        const appContainer = document.getElementById('app-container');

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const userDoc = await getDoc(doc(usersRef, user.uid));
                    if(userDoc.exists()) {
                        const data = userDoc.data();
                        const badges = data.badges || [];
                        
                        if(badges.includes('staff')) currentUserRole = 'staff';
                        else if(badges.includes('patron')) currentUserRole = 'patron';
                        else {
                            // Erreur 1: Pas les droits
                            throw new Error("Désolé ce compte n'est ni administrateur ni Patron, vous ne pouvez pas avoir accès à ce site");
                        }
                        
                        setupUIForRole(currentUserRole);
                        authView.style.display = 'none';
                        appContainer.style.display = 'flex';
                        loadDashboard();
                        loadCMS(); 
                        loadFeedbacks(); 
                    } else {
                        // Erreur 2: Compte existe Auth mais pas en base (bizarre mais possible) -> traité comme "Pas de compte"
                        throw new Error("Désolé ces identifiants ne sont attribués à aucun compte.");
                    }
                } catch(e) {
                    console.error(e);
                    document.getElementById('login-msg').textContent = e.message;
                    await signOut(auth); // Déconnexion forcée
                    authView.style.display = 'flex';
                    appContainer.style.display = 'none';
                }
            } else {
                authView.style.display = 'flex';
                appContainer.style.display = 'none';
            }
        });

        function handleAuthError(error) {
            let msg = "Une erreur est survenue.";
            if(error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential' || error.code === 'auth/invalid-email') {
                msg = "Désolé ces identifiants ne sont attribués à aucun compte.";
            } else {
                msg = error.message;
            }
            document.getElementById('login-msg').textContent = msg;
        }

        function setupUIForRole(role) {
            document.getElementById('user-role-display').textContent = role.toUpperCase();
            const navUsers = document.querySelector('.nav-item[data-target="users"]');
            const navCMS = document.querySelector('.nav-item[data-target="cms"]');
            const navFeedbacks = document.querySelector('.nav-item[data-target="feedbacks"]');
            
            if(role === 'patron') {
                navUsers.classList.add('disabled');
                navCMS.classList.add('disabled');
                navFeedbacks.classList.add('disabled'); 
                switchTab('dashboard');
            } else {
                navUsers.classList.remove('disabled');
                navCMS.classList.remove('disabled');
                navFeedbacks.classList.remove('disabled');
            }
        }

        document.getElementById('login-btn').addEventListener('click', async () => {
            const email = document.getElementById('admin-email').value;
            const pass = document.getElementById('admin-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) {
                handleAuthError(e);
            }
        });

        document.getElementById('google-login-btn').addEventListener('click', async () => {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (e) {
                handleAuthError(e);
            }
        });

        window.logout = () => signOut(auth);

        // --- DASHBOARD LOGIC ---
        async function loadDashboard() {
            try {
                const usersSnap = await getDocs(query(usersRef, limit(100)));
                allUsers = [];
                usersSnap.forEach(d => allUsers.push({id: d.id, ...d.data()}));
                document.getElementById('stat-total-users').textContent = allUsers.length + (allUsers.length===100?'+':'');
                
                renderUsersTable(allUsers);
                renderPatronsTable(allUsers);
                updateGrowthChart(allUsers); // REAL CHART DATA
            } catch(e) { console.error("Users Error", e); document.getElementById('stat-total-users').textContent = 'Err'; }

            try {
                const postsSnap = await getDocs(query(postsRef, limit(50))); 
                document.getElementById('stat-total-posts').textContent = postsSnap.size + '+';
            } catch(e) { console.error("Posts Error", e); document.getElementById('stat-total-posts').textContent = 'Err'; }

            try {
                const groupsSnap = await getDocs(query(groupsRef, limit(50)));
                document.getElementById('stat-total-groups').textContent = groupsSnap.size;
            } catch(e) { 
                console.error("Groups Error", e); 
                // Si permission error (Staff/Patron should see), c'est probablement que l'utilisateur courant n'a pas le badge en base ou les règles ont du mal.
                // On met 0 pour éviter 'Err' moche.
                document.getElementById('stat-total-groups').textContent = '?';
            }
            
            if(currentUserRole === 'staff') {
                try {
                    const fbSnap = await getDocs(query(feedbacksRef));
                    document.getElementById('stat-feedbacks-count').textContent = fbSnap.size;
                } catch(e) { console.error("Feedback Error", e); }
            } else {
                document.getElementById('stat-feedbacks-count').textContent = '-';
            }
        }

        function updateGrowthChart(users) {
            // Regrouper les utilisateurs par date de création (accountCreatedAt)
            const counts = {};
            // On initialise les 7 derniers jours à 0
            const today = new Date();
            for(let i=6; i>=0; i--) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                const k = d.toLocaleDateString('fr-FR');
                counts[k] = 0;
            }

            users.forEach(u => {
                if(u.accountCreatedAt) {
                    // Firebase timestamp to date
                    const d = u.accountCreatedAt.toDate ? u.accountCreatedAt.toDate() : new Date();
                    const k = d.toLocaleDateString('fr-FR');
                    if(counts[k] !== undefined) counts[k]++;
                }
            });

            const labels = Object.keys(counts);
            const data = Object.values(counts);

            const ctx = document.getElementById('growthChart').getContext('2d');
            if(growthChartInstance) growthChartInstance.destroy();
            
            growthChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Inscriptions (7 derniers jours)',
                        data: data,
                        borderColor: '#3897f0',
                        backgroundColor: 'rgba(56, 151, 240, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // --- CMS LOGIC ---
        async function loadCMS() {
            if(currentUserRole === 'patron') return;
            try {
                const docSnap = await getDoc(cmsDocRef);
                let data = docSnap.exists() ? docSnap.data() : { roadmap: [] };
                if(!data.roadmap) data.roadmap = [];
                renderCMSInputs(data);
            } catch(e) { console.error("CMS Load Error:", e); }
        }

        function renderCMSInputs(data) {
            const rContainer = document.getElementById('cms-roadmap-container');
            rContainer.innerHTML = ''; 

            data.roadmap.forEach((item, i) => {
                const div = document.createElement('div'); div.className = 'cms-item';
                div.innerHTML = `
                    <div class="cms-content">
                        <input class="cms-input roadmap-ver" value="${item.version || ''}" placeholder="Version (ex: v1.2)">
                        <input class="cms-input roadmap-title" value="${item.title || ''}" placeholder="Titre">
                        <input class="cms-input roadmap-desc" value="${item.desc || ''}" placeholder="Description">
                    </div>
                    <div class="cms-actions">
                        <button class="action-icon-btn" onclick="this.closest('.cms-item').remove()"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                rContainer.appendChild(div);
            });
        }

        window.addRoadmapItem = () => {
            const rContainer = document.getElementById('cms-roadmap-container');
            const div = document.createElement('div'); div.className = 'cms-item';
            div.innerHTML = `
                <div class="cms-content">
                    <input class="cms-input roadmap-ver" placeholder="Version (ex: v1.3)">
                    <input class="cms-input roadmap-title" placeholder="Titre">
                    <input class="cms-input roadmap-desc" placeholder="Description">
                </div>
                <div class="cms-actions"><button class="action-icon-btn" onclick="this.closest('.cms-item').remove()"><i class="fas fa-trash"></i></button></div>
            `;
            rContainer.prepend(div);
        };

        window.saveCMS = async () => {
            if(currentUserRole === 'patron') return;
            const roadmapItems = [];
            document.querySelectorAll('#cms-roadmap-container .cms-item').forEach(div => {
                roadmapItems.push({
                    version: div.querySelector('.roadmap-ver').value,
                    title: div.querySelector('.roadmap-title').value,
                    desc: div.querySelector('.roadmap-desc').value
                });
            });

            try {
                await setDoc(cmsDocRef, { roadmap: roadmapItems }, { merge: true });
                showToast("Roadmap mise à jour !");
            } catch(e) { showToast("Erreur sauvegarde."); }
        };
        
        // --- FEEDBACKS ---
        async function loadFeedbacks() {
            if(currentUserRole === 'patron') return;
            try {
                const snap = await getDocs(query(feedbacksRef, orderBy('createdAt', 'desc'), limit(20)));
                const list = document.getElementById('feedback-list');
                list.innerHTML = '';
                if(snap.empty) { list.innerHTML = '<div style="color:#888;">Aucun retour.</div>'; return; }
                snap.forEach(d => {
                    const data = d.data();
                    const date = data.createdAt ? new Date(data.createdAt.seconds*1000).toLocaleString() : 'Inconnue';
                    const div = document.createElement('div'); div.className = 'feedback-item';
                    div.innerHTML = `
                        <div class="feedback-meta">
                            <span>De: <b>${data.email || 'Anonyme'}</b></span>
                            <span>${date}</span>
                        </div>
                        <div style="font-size:14px;">${data.message}</div>
                    `;
                    list.appendChild(div);
                });
            } catch(e) {
                console.error("Feedbacks Load Error:", e);
                const list = document.getElementById('feedback-list');
                list.innerHTML = '<div style="color:red;">Erreur de chargement (Permissions). Vérifiez que vous êtes bien Staff dans Firestore.</div>';
            }
        }

        // --- NAVIGATION ---
        window.switchTab = (tabId) => {
            if(currentUserRole === 'patron' && (tabId === 'users' || tabId === 'cms' || tabId === 'feedbacks')) return;
            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId + '-view').classList.add('active');
            const navBtn = document.querySelector(`.nav-item[data-target="${tabId}"]`);
            if(navBtn) navBtn.classList.add('active');
        };

        // --- USERS TABLE ---
        window.renderUsersTable = (users) => {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';
            users.forEach(u => {
                const tr = document.createElement('tr');
                tr.className = 'user-row';
                tr.onclick = () => openEditUser(u);
                
                let badgesHtml = '';
                const badges = u.badges || [];
                if(badges.includes('staff')) badgesHtml += '<span class="badge-tag badge-staff">STAFF</span>';
                if(badges.includes('vip')) badgesHtml += '<span class="badge-tag badge-vip">VIP</span>';
                if(badges.includes('certif')) badgesHtml += '<span class="badge-tag badge-certif">CERTIF</span>';
                if(badges.includes('patron')) badgesHtml += '<span class="badge-tag" style="background:#8e44ad">PATRON</span>';

                tr.innerHTML = `
                    <td><img src="https://ui-avatars.com/api/?name=${u.username}&background=random&color=fff" style="width:30px;height:30px;border-radius:50%;"></td>
                    <td><b>${u.username}</b></td>
                    <td style="font-family:monospace; color:#888;">${u.id.substring(0,8)}...</td>
                    <td>${badgesHtml}</td>
                    <td>${u.referredBy ? u.referredBy.substring(0,8)+'...' : '-'}</td>
                    <td><button class="btn" style="padding:5px 10px; font-size:12px; width:auto;">Éditer</button></td>
                `;
                tbody.appendChild(tr);
            });
        };

        window.filterUsers = () => {
            const term = document.getElementById('user-search').value.toLowerCase();
            const filtered = allUsers.filter(u => u.username.toLowerCase().includes(term) || u.id.includes(term));
            renderUsersTable(filtered);
        };

        // --- EDIT USER ---
        window.openEditUser = (u) => {
            if(currentUserRole === 'patron') return;
            editingUserId = u.id;
            document.getElementById('modal-user-info').innerHTML = `Utilisateur: <b>${u.username}</b><br>ID: ${u.id}`;
            const badges = u.badges || [];
            document.getElementById('badge-staff').checked = badges.includes('staff');
            document.getElementById('badge-vip').checked = badges.includes('vip');
            document.getElementById('badge-certif').checked = badges.includes('certif');
            document.getElementById('badge-patron').checked = badges.includes('patron');
            
            document.getElementById('user-modal').style.display = 'flex';
        };

        window.closeModal = () => { document.getElementById('user-modal').style.display = 'none'; editingUserId = null; };

        window.saveUserChanges = async () => {
            if(!editingUserId) return;
            const newBadges = [];
            if(document.getElementById('badge-staff').checked) newBadges.push('staff');
            if(document.getElementById('badge-vip').checked) newBadges.push('vip');
            if(document.getElementById('badge-certif').checked) newBadges.push('certif');
            if(document.getElementById('badge-patron').checked) newBadges.push('patron');
            
            try {
                await updateDoc(doc(usersRef, editingUserId), { badges: newBadges });
                const idx = allUsers.findIndex(u => u.id === editingUserId);
                if(idx !== -1) allUsers[idx].badges = newBadges;
                
                renderUsersTable(allUsers);
                renderPatronsTable(allUsers); 
                closeModal();
                showToast("Modifications enregistrées !");
            } catch(e) {
                console.error(e);
                showToast("Erreur sauvegarde.");
            }
        };

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        // --- PATRONS LOGIC ---
        function renderPatronsTable(users) {
            const tbody = document.getElementById('patrons-table-body');
            tbody.innerHTML = '';
            
            const patrons = users.filter(u => (u.badges||[]).includes('patron'));
            
            if(patrons.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Aucun patron pour le moment.</td></tr>';
                return;
            }

            patrons.forEach(p => {
                const referralCount = users.filter(u => u.referredBy === p.id).length;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <img src="https://ui-avatars.com/api/?name=${p.username}&background=random&color=fff" style="width:30px;height:30px;border-radius:50%;">
                            <b>${p.username}</b>
                        </div>
                    </td>
                    <td><span style="font-weight:bold; color:var(--highlight-color);">${referralCount}</span></td>
                    <td><code style="background:#f0f0f0; padding:4px;">drop-24.netlify.app?ref=${p.id}</code></td>
                `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
