<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drop | Modération & Marketing</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        :root {
            --primary-bg: #FAFAFA;
            --secondary-bg: #FFFFFF;
            --sidebar-bg: #FFFFFF;
            --border-color: #DBDBDB;
            --text-color: #262626;
            --highlight-color: #3897f0;
            --danger-color: #E74C3C;
            --success-color: #2ECC71;
            --warning-color: #F1C40F;
            --gray-text: #8E8E8E;
        }

        body {
            margin: 0; padding: 0; font-family: 'Inter', sans-serif;
            background-color: var(--primary-bg); color: var(--text-color);
            height: 100vh; display: flex; overflow: hidden;
        }

        /* --- LOGIN VIEW --- */
        #auth-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--primary-bg); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
        }
        .auth-card {
            background: var(--secondary-bg); padding: 40px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 350px; text-align: center;
            border: 1px solid var(--border-color);
        }
        .logo { font-family: 'Inter', sans-serif; font-weight: 800; font-size: 28px; margin-bottom: 20px; display:block;}
        .logo span { color: var(--highlight-color); }
        .auth-input {
            width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border-color);
            border-radius: 6px; background: #fafafa;
        }
        .btn {
            width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: 600;
            cursor: pointer; transition: opacity 0.2s; color: white; background-color: var(--highlight-color);
        }
        .btn:hover { opacity: 0.9; }

        /* --- MAIN LAYOUT --- */
        #app-container { display: none; width: 100%; height: 100%; }

        /* SIDEBAR */
        .sidebar {
            width: 250px; background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; padding: 20px 0; flex-shrink: 0;
        }
        .sidebar-header { padding: 0 20px 30px; }
        .nav-item {
            padding: 15px 20px; cursor: pointer; color: var(--text-color); font-weight: 500;
            display: flex; align-items: center; gap: 10px; transition: background 0.2s;
        }
        .nav-item:hover { background-color: #f0f0f0; }
        .nav-item.active { border-left: 4px solid var(--highlight-color); background-color: #f8fbff; color: var(--highlight-color); }
        .nav-item i { width: 20px; text-align: center; }

        /* CONTENT */
        .main-content { flex-grow: 1; overflow-y: auto; padding: 30px; position: relative; }
        .section-view { display: none; animation: fadeIn 0.3s; }
        .section-view.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }

        /* DASHBOARD CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--highlight-color); margin: 10px 0; }
        .stat-label { font-size: 14px; color: var(--gray-text); }

        /* USERS TABLE */
        .search-bar { width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 6px; }
        .data-table { width: 100%; border-collapse: collapse; background: white; font-size: 14px; }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .data-table th { background-color: #f9f9f9; font-weight: 600; color: var(--gray-text); }
        .user-row:hover { background-color: #f0f0f0; cursor: pointer; }
        .badge-tag { padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; margin-right: 5px; color: white; display: inline-block; }
        .badge-vip { background-color: var(--warning-color); }
        .badge-staff { background-color: var(--highlight-color); }
        .badge-certif { background-color: var(--success-color); }
        
        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5);
            display: none; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal { background: white; padding: 30px; border-radius: 12px; width: 400px; max-width: 90%; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .checkbox-group { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .checkbox-item { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        
        /* TOAST */
        #toast { position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; background: #333; color: white; border-radius: 4px; display: none; z-index: 3000; }

    </style>
</head>
<body>

    <!-- AUTH SCREEN -->
    <div id="auth-view">
        <div class="auth-card">
            <div class="logo">Drop <span>Modération</span></div>
            <p style="color:#666; font-size:14px; margin-bottom:20px;">Accès réservé au Staff & Marketing</p>
            <input type="email" id="admin-email" class="auth-input" placeholder="Email administrateur" value="admin@drop.com">
            <input type="password" id="admin-password" class="auth-input" placeholder="Mot de passe">
            <button id="login-btn" class="btn">Connexion Sécurisée</button>
            <div id="login-msg" style="margin-top:10px; font-size:12px; color: var(--danger-color);"></div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-container">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">Drop <span>Admin</span></div>
                <div style="font-size:12px; color:#888;">v1.0.0 (Bêta)</div>
            </div>
            <nav>
                <div class="nav-item active" onclick="switchTab('dashboard')"><i class="fas fa-chart-line"></i> Dashboard</div>
                <div class="nav-item" onclick="switchTab('users')"><i class="fas fa-users"></i> Gestion Utilisateurs</div>
                <div class="nav-item" onclick="switchTab('patrons')"><i class="fas fa-briefcase"></i> Patrons & Parrainage</div>
                <div class="nav-item" onclick="switchTab('settings')"><i class="fas fa-cog"></i> Paramètres</div>
            </nav>
            <div style="margin-top: auto; padding: 20px;">
                <button onclick="logout()" style="background:none; border:none; color:var(--danger-color); cursor:pointer; font-weight:600;"><i class="fas fa-sign-out-alt"></i> Déconnexion</button>
            </div>
        </div>

        <!-- CONTENT -->
        <div class="main-content">
            
            <!-- DASHBOARD -->
            <div id="dashboard-view" class="section-view active">
                <h2>Vue d'ensemble</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Utilisateurs Totaux</div>
                        <div class="stat-value" id="stat-total-users">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Posts Totaux</div>
                        <div class="stat-value" id="stat-total-posts">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Groupes Actifs</div>
                        <div class="stat-value" id="stat-total-groups">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Tendances (Posts)</div>
                        <div class="stat-value" id="stat-trends-count">-</div>
                        <div style="font-size:12px; color:gray;">Sur les 40 derniers posts</div>
                    </div>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); height: 300px;">
                    <canvas id="growthChart"></canvas>
                </div>
            </div>

            <!-- USERS MANAGEMENT -->
            <div id="users-view" class="section-view">
                <h2>Gestion des Utilisateurs</h2>
                <input type="text" id="user-search" class="search-bar" placeholder="Rechercher par pseudo ou ID..." onkeyup="filterUsers()">
                <div style="overflow-x:auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Avatar</th>
                                <th>Pseudo</th>
                                <th>ID</th>
                                <th>Badges</th>
                                <th>Amis</th>
                                <th>Posts</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <!-- JS Generated -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PATRONS -->
            <div id="patrons-view" class="section-view">
                <h2>Espace Patrons & Parrainage</h2>
                <div style="display:flex; gap:20px; align-items:flex-start; flex-wrap: wrap;">
                    <!-- Add Patron -->
                    <div class="stat-card" style="flex: 1; min-width: 300px;">
                        <h3>Ajouter un Patron</h3>
                        <p style="font-size:12px; color:gray;">Entrez l'ID de l'utilisateur pour lui donner le statut "Patron".</p>
                        <input type="text" id="new-patron-id" class="auth-input" placeholder="ID Utilisateur">
                        <button class="btn" onclick="addPatron()">Promouvoir Patron</button>
                    </div>

                    <!-- Leaderboard -->
                    <div class="stat-card" style="flex: 2; min-width: 300px;">
                        <h3>Classement des Patrons</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Patron</th>
                                    <th>Parrainés (Total)</th>
                                    <th>Lien</th>
                                </tr>
                            </thead>
                            <tbody id="patrons-table-body">
                                <tr><td colspan="3">Chargement...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- SETTINGS -->
             <div id="settings-view" class="section-view">
                <h2>Paramètres Système</h2>
                <p>Version du canevas : 1.0.0</p>
                <p style="color:red; font-weight:bold;">Zone Danger</p>
                <p>Les fonctionnalités de suppression de masse ne sont pas encore activées dans cette version.</p>
            </div>

        </div>
    </div>

    <!-- USER EDIT MODAL -->
    <div id="user-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 style="margin:0;">Modifier l'utilisateur</h3>
                <i class="fas fa-times" style="cursor:pointer;" onclick="closeModal()"></i>
            </div>
            <div id="modal-user-info" style="margin-bottom:20px; font-size:14px; color:#555;"></div>
            
            <label style="font-weight:bold;">Attribution de Badges</label>
            <div class="checkbox-group">
                <label class="checkbox-item"><input type="checkbox" id="badge-staff"> Staff Drop (Admin)</label>
                <label class="checkbox-item"><input type="checkbox" id="badge-vip"> VIP (Utilisateur Important)</label>
                <label class="checkbox-item"><input type="checkbox" id="badge-certif"> Certifié (Créateur)</label>
                <label class="checkbox-item"><input type="checkbox" id="badge-patron"> Patron (Marketing)</label>
            </div>

            <div class="modal-actions">
                <button class="btn" style="background:#ccc; color:black;" onclick="closeModal()">Annuler</button>
                <button class="btn" onclick="saveUserChanges()">Enregistrer</button>
            </div>
        </div>
    </div>

    <div id="toast"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, query, limit, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIG (Même que l'app principale) ---
        const appId = '1:541715107757:web:0141b71ee3cd1ce5ec5b24';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
             apiKey: "AIzaSyB_z5U4yKJERho93p9696NujcG5R5fvlD8",
             authDomain: "studio-3374032724-f28d6.firebaseapp.com",
             projectId: "studio-3374032724-f28d6",
             appId: appId
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- CONSTANTS ---
        const dbPath = `artifacts/${appId}/public/data`;
        const usersRef = collection(db, dbPath, 'users');
        const postsRef = collection(db, dbPath, 'posts');
        const groupsRef = collection(db, dbPath, 'groups');

        // Liste blanche des admins (SIMULATION SÉCURITÉ)
        const ALLOWED_EMAILS = ['admin@drop.com', 'marketing@drop.com', 'test@test.com'];

        // STATE
        let allUsers = [];
        let editingUserId = null;

        // --- AUTH LOGIC ---
        const authView = document.getElementById('auth-view');
        const appContainer = document.getElementById('app-container');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Simulation check admin
                // Note: Dans une vraie prod, ceci doit être fait via Custom Claims ou Firestore Rules
                // Pour le canevas, on laisse entrer tout utilisateur connecté pour tester
                authView.style.display = 'none';
                appContainer.style.display = 'flex';
                loadDashboard();
            } else {
                authView.style.display = 'flex';
                appContainer.style.display = 'none';
            }
        });

        document.getElementById('login-btn').addEventListener('click', async () => {
            const email = document.getElementById('admin-email').value;
            const pass = document.getElementById('admin-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) {
                document.getElementById('login-msg').textContent = "Erreur: " + e.message;
            }
        });

        window.logout = () => signOut(auth);

        // --- DASHBOARD LOGIC ---
        async function loadDashboard() {
            // Fetch users (limité à 100 pour la démo/perf)
            const usersSnap = await getDocs(query(usersRef, limit(100)));
            allUsers = [];
            usersSnap.forEach(d => allUsers.push({id: d.id, ...d.data()}));
            
            // Update Stats
            document.getElementById('stat-total-users').textContent = allUsers.length + (allUsers.length===100?'+':'');
            
            const postsSnap = await getDocs(query(postsRef, limit(50))); // Just to get a count idea
            document.getElementById('stat-total-posts').textContent = postsSnap.size + '+';
            
            const groupsSnap = await getDocs(query(groupsRef, limit(50)));
            document.getElementById('stat-total-groups').textContent = groupsSnap.size;
            
            // Render Users Table
            renderUsersTable(allUsers);
            renderPatronsTable(allUsers);
            
            // Mock Chart
            const ctx = document.getElementById('growthChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'],
                    datasets: [{
                        label: 'Nouveaux Inscrits',
                        data: [12, 19, 3, 5, 2, 3, 10], // Mock data
                        borderColor: '#3897f0',
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // --- NAVIGATION ---
        window.switchTab = (tabId) => {
            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId + '-view').classList.add('active');
            // Trouver l'index pour highlight le nav item (approximatif)
            const navs = document.querySelectorAll('.nav-item');
            if(tabId === 'dashboard') navs[0].classList.add('active');
            if(tabId === 'users') navs[1].classList.add('active');
            if(tabId === 'patrons') navs[2].classList.add('active');
            if(tabId === 'settings') navs[3].classList.add('active');
        };

        // --- USERS TABLE ---
        window.renderUsersTable = (users) => {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';
            users.forEach(u => {
                const tr = document.createElement('tr');
                tr.className = 'user-row';
                tr.onclick = () => openEditUser(u);
                
                let badgesHtml = '';
                const badges = u.badges || [];
                if(badges.includes('staff')) badgesHtml += '<span class="badge-tag badge-staff">STAFF</span>';
                if(badges.includes('vip')) badgesHtml += '<span class="badge-tag badge-vip">VIP</span>';
                if(badges.includes('certif')) badgesHtml += '<span class="badge-tag badge-certif">CERTIF</span>';
                if(badges.includes('patron')) badgesHtml += '<span class="badge-tag" style="background:#8e44ad">PATRON</span>';

                tr.innerHTML = `
                    <td><img src="https://ui-avatars.com/api/?name=${u.username}&background=random&color=fff" style="width:30px;height:30px;border-radius:50%;"></td>
                    <td><b>${u.username}</b></td>
                    <td style="font-family:monospace; color:#888;">${u.id.substring(0,8)}...</td>
                    <td>${badgesHtml}</td>
                    <td>${(u.friends||[]).length}</td>
                    <td>${u.postsCount||0}</td>
                    <td><button class="btn" style="padding:5px 10px; font-size:12px; width:auto;">Éditer</button></td>
                `;
                tbody.appendChild(tr);
            });
        };

        window.filterUsers = () => {
            const term = document.getElementById('user-search').value.toLowerCase();
            const filtered = allUsers.filter(u => u.username.toLowerCase().includes(term) || u.id.includes(term));
            renderUsersTable(filtered);
        };

        // --- EDIT USER ---
        window.openEditUser = (u) => {
            editingUserId = u.id;
            document.getElementById('modal-user-info').innerHTML = `Utilisateur: <b>${u.username}</b><br>ID: ${u.id}`;
            const badges = u.badges || [];
            document.getElementById('badge-staff').checked = badges.includes('staff');
            document.getElementById('badge-vip').checked = badges.includes('vip');
            document.getElementById('badge-certif').checked = badges.includes('certif');
            document.getElementById('badge-patron').checked = badges.includes('patron');
            
            document.getElementById('user-modal').style.display = 'flex';
        };

        window.closeModal = () => { document.getElementById('user-modal').style.display = 'none'; editingUserId = null; };

        window.saveUserChanges = async () => {
            if(!editingUserId) return;
            const newBadges = [];
            if(document.getElementById('badge-staff').checked) newBadges.push('staff');
            if(document.getElementById('badge-vip').checked) newBadges.push('vip');
            if(document.getElementById('badge-certif').checked) newBadges.push('certif');
            if(document.getElementById('badge-patron').checked) newBadges.push('patron');
            
            try {
                await updateDoc(doc(usersRef, editingUserId), { badges: newBadges });
                // Update local data
                const idx = allUsers.findIndex(u => u.id === editingUserId);
                if(idx !== -1) allUsers[idx].badges = newBadges;
                
                renderUsersTable(allUsers);
                renderPatronsTable(allUsers); // Refresh patrons too
                closeModal();
                showToast("Modifications enregistrées !");
            } catch(e) {
                console.error(e);
                showToast("Erreur sauvegarde.");
            }
        };

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        // --- PATRONS LOGIC ---
        window.addPatron = async () => {
            const id = document.getElementById('new-patron-id').value.trim();
            if(!id) return;
            try {
                // On ajoute simplement le badge 'patron' à l'utilisateur
                // Note: La règle de sécurité actuelle permet l'update.
                // Dans un vrai système, on utiliserait arrayUnion. Ici on fetch/update simple pour le canevas.
                const user = allUsers.find(u => u.id === id);
                if(!user) return showToast("Utilisateur introuvable dans le cache local.");
                
                const currentBadges = user.badges || [];
                if(!currentBadges.includes('patron')) {
                    const newBadges = [...currentBadges, 'patron'];
                    await updateDoc(doc(usersRef, id), { badges: newBadges });
                    user.badges = newBadges; // Local update
                    renderPatronsTable(allUsers);
                    showToast("Utilisateur promu Patron !");
                } else {
                    showToast("Déjà Patron.");
                }
            } catch(e) { showToast("Erreur update."); }
        };

        function renderPatronsTable(users) {
            const tbody = document.getElementById('patrons-table-body');
            tbody.innerHTML = '';
            
            // Filter users who have 'patron' badge
            const patrons = users.filter(u => (u.badges||[]).includes('patron'));
            
            if(patrons.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Aucun patron pour le moment.</td></tr>';
                return;
            }

            patrons.forEach(p => {
                // Count referrals (Mock logic: in real app, we would query users where referredBy == p.id)
                // For this canvas, we just show 0 or a mock number based on friend count maybe?
                // Let's assume we count friends as a proxy for "Network" for now as we don't have referredBy in DB yet.
                const referrals = (p.friends || []).length; 
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <img src="https://ui-avatars.com/api/?name=${p.username}&background=random&color=fff" style="width:30px;height:30px;border-radius:50%;">
                            <b>${p.username}</b>
                        </div>
                    </td>
                    <td><span style="font-weight:bold; color:var(--highlight-color);">${referrals}</span> (Simulé via Amis)</td>
                    <td><code style="background:#f0f0f0; padding:4px;">drop-24.netlify.app?ref=${p.id}</code></td>
                `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
